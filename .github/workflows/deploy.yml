name: Deploy Hotel Backend to Azure VM

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.12.3"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run tests
              env:
                  SECRET_KEY: test-secret-key
              run: |
                  python ./hotel_reservation_api/manage.py test

    deploy:
        needs: test
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        steps:
            - uses: actions/checkout@v4

            - name: Deploy to Azure VM
              env:
                  HOST: ${{ secrets.HOST }}
                  USER: ${{ secrets.USER }}
                  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
                  PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
              run: |
                  ssh $USER@$HOST "
                    set -e

                    echo 'âœ… 1. Actualizando cÃ³digo...'
                    cd $DEPLOY_PATH
                    git fetch origin
                    git reset --hard origin/main

                    echo 'âœ… 2. Activando entorno virtual...'
                    source $DEPLOY_PATH/.venv/bin/activate

                    echo 'âœ… 3. Instalando dependencias...'
                    pip install -r requirements.txt

                    echo 'âœ… 4. Se cambia al directorio del proyecto...'
                    cd $DEPLOY_PATH

                    echo 'âœ… 5. Aplicando migraciones...'
                    python manage.py migrate --noinput

                    echo 'âœ… 6. Colectando archivos estÃ¡ticos...'
                    python manage.py collectstatic --noinput --clear

                    echo 'âœ… 7. Reiniciando servicios...'
                    sudo systemctl restart gunicorn
                    sudo systemctl restart nginx

                    echo 'ðŸš€ DESPLIEGUE COMPLETADO CON Ã‰XITO'
                  "
