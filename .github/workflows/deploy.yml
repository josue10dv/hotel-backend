name: Deploy Hotel Backend to Azure VM

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.12.3"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run tests
              env:
                  SECRET_KEY: test-secret-key
                  DEBUG: "True"
                  ALLOWED_HOSTS: "*"
                  DB_NAME: test_db
                  DB_USER: test_user
                  DB_PASS: test_password
                  DB_HOST: localhost
                  DB_PORT: "5432"
                  MONGO_DB_NAME: test_hotel_reservations
                  MONGO_HOST: localhost
                  MONGO_PORT: "27017"
                  MONGO_USER: test_user
                  MONGO_PASSWORD: test_password
                  JWT_ACCESS_MINUTES: "60"
                  JWT_REFRESH_DAYS: "7"
                  REFRESH_TOKEN_COOKIE_NAME: refresh_token
                  PROD_FLAG: "False"
              run: |
                  python ./hotel_reservation_api/manage.py test

    deploy:
        needs: test
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        steps:
            - uses: actions/checkout@v4

            - name: Setup SSH
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
                  HOST: ${{ secrets.HOST }}
              run: |
                  mkdir -p ~/.ssh
                  echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

            - name: Deploy to Azure VM
              env:
                  HOST: ${{ secrets.HOST }}
                  USER: ${{ secrets.USER }}
                  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
                  PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
              run: |
                  ssh $USER@$HOST "
                    set -e

                    echo 'âœ… 1. Actualizando cÃ³digo...'
                    cd $DEPLOY_PATH
                    git fetch origin
                    git reset --hard origin/main

                    echo 'âœ… 2. Activando entorno virtual...'
                    source $DEPLOY_PATH/.venv/bin/activate

                    echo 'âœ… 3. Instalando dependencias...'
                    pip install -r requirements.txt

                    echo 'âœ… 4. Corrigiendo permisos del archivo .env...'
                    sudo chown azure_root:azure_root $DEPLOY_PATH/.env
                    sudo chmod 640 $DEPLOY_PATH/.env

                    echo 'âœ… 5. Se cambia al directorio del proyecto...'
                    cd $DEPLOY_PATH/hotel_reservation_api

                    echo 'âœ… 6. Aplicando migraciones...'
                    python manage.py migrate --noinput

                    echo 'âœ… 7. Colectando archivos estÃ¡ticos...'
                    python manage.py collectstatic --noinput --clear

                    echo 'âœ… 8. Reiniciando servicios...'
                    sudo systemctl restart gunicorn
                    sudo systemctl restart nginx

                    echo 'ðŸš€ DESPLIEGUE COMPLETADO CON Ã‰XITO'
                  "
